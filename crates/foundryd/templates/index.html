<div class="page-header">
  <h1 class="page-title">Dashboard</h1>
  <div class="live-indicator"><span class="live-dot"></span> Live</div>
</div>

<div class="stats-grid" id="stats">
  <div class="stat-card">
    <div class="stat-label">Total Builds</div>
    <div class="stat-value" id="stat-total">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Today</div>
    <div class="stat-value" id="stat-today">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Success Rate</div>
    <div class="stat-value success" id="stat-rate">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">In Queue</div>
    <div class="stat-value warning" id="stat-queued">-</div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <span>Recent Builds</span>
    <a href="/repos" class="btn">View Repositories â†’</a>
  </div>
  <table>
    <thead>
      <tr>
        <th>Build</th>
        <th>Commit</th>
        <th>Status</th>
        <th>Duration</th>
        <th>Started</th>
      </tr>
    </thead>
    <tbody id="jobs-table">
      <tr>
        <td
          colspan="5"
          style="text-align: center; padding: 40px; color: var(--fg-muted)"
        >
          Loading...
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  async function loadStats() {
    try {
      const res = await fetch("/api/stats");
      const stats = await res.json();
      document.getElementById("stat-total").textContent = stats.total_jobs;
      document.getElementById("stat-today").textContent = stats.jobs_today;
      document.getElementById("stat-rate").textContent =
        stats.success_rate.toFixed(1) + "%";
      document.getElementById("stat-queued").textContent =
        stats.queued_count + stats.running_count;
    } catch (e) {
      console.error("Failed to load stats:", e);
    }
  }

  async function loadJobs() {
    try {
      const res = await fetch("/api/jobs?limit=20");
      const jobs = await res.json();
      const tbody = document.getElementById("jobs-table");

      if (jobs.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--fg-muted)">No builds yet. Push a commit to get started!</td></tr>';
        return;
      }

      tbody.innerHTML = jobs
        .map(
          (job) => `
            <tr>
                <td>
                    <a href="/job/${job.id}" style="font-weight:500">#${
            job.id
          }</a>
                    <div class="commit-meta">${job.repo_owner}/${
            job.repo_name
          }</div>
                </td>
                <td>
                    <div class="commit-msg">${
                      job.commit_message || "No message"
                    }</div>
                    <div class="commit-meta">
                        <code>${job.git_sha.substring(0, 7)}</code>
                        ${job.commit_author ? " by " + job.commit_author : ""}
                    </div>
                </td>
                <td>${statusHtml(job.status)}</td>
                <td class="duration">${formatDuration(job.duration_secs)}</td>
                <td class="duration">${formatRelative(job.created_at)}</td>
            </tr>
        `
        )
        .join("");
    } catch (e) {
      console.error("Failed to load jobs:", e);
    }
  }

  // Initial load
  loadStats();
  loadJobs();

  // Auto-refresh every 5 seconds
  setInterval(() => {
    loadStats();
    loadJobs();
  }, 5000);
</script>
